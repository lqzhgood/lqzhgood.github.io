---
title: 外网监测脚本
categories:
  - study
  - openwrt
tags:
  - shell
  - dns
  - chinadns
date: 2016-05-31 13:39:38
---

最近DNS老是解析错误，感觉 Chinadns 老挂啊。今天刚好休息，写个监控脚本解决下这个问题.

好久没写 shell 脚本，被 JavaScript 的宽松语法惯坏了。一个 if then 结构都琢磨了一小时，最后发现 if 是接 [ ] 而不是 { } …… 真是郁闷
<!--more-->

```bash
#!/bin/sh

#开机多拨延迟100s
sleep 100
DATE=`date +%Y-%m-%d-%H:%M:%S`
tries=0

SS=0
DNS=0
#固定IP地址 要确定域名对应的IP不会变 这里我写的自己VPS域名对应的IP
ip2="X.X.X.X"


echo --- my_watchdog start ---
while [[ $tries -lt 5 ]]
do
#ss
	wget -4 --spider --quiet --tries=1 --timeout=3 www.google.co.jp
	if [ "$?" == "0" ]; then
		SS=0
	else
		wget -4 --spider --quiet --tries=1 --timeout=3 www.baidu.com
		if [ "$?" == "0" ]; then
			echo $DATE Problem shadowsocks. SS $tries >> /root/log/ss1.log
			SS=$((SS+1))
		else
			echo  $DATE Network Problem. Do nothing. SS $tries >> /root/log/ss1.log
		fi
	fi

#dns
	ip=$(nslookup chh-hk.noip.me 127.0.0.1 | tail -1 | awk '{print $3}')
	if [ $ip == $ip2 ]; then
		DNS=0		
	else
		DNS=$((DNS+1))
		echo $DATE Problem DNS. DNS $tries >> /root/log/ss1.log
	fi

#restart
	if [ $SS == "0" -a $DNS == "0" ]; then
                echo --- exit ---
                exit 0
	fi

   tries=$((tries+1))
   sleep 2

done


echo $DATE restart >> /root/log/ss1.log
/etc/init.d/shadowsocks restart
/etc/init.d/dnsmasq restart
/etc/init.d/chinadns restart

```


主要判断 SS 和 DNS 是否正常，如果正常则跳出，否则继续判断直到5次，5次不成功重启相关服务。
测试几天 以观后效。
