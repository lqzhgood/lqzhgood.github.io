(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-77d593af"],{"6ad4":function(e,t,n){"use strict";n.r(t);var r=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"app-container",attrs:{id:"video-preview-mobile"}},[n("div",{staticClass:"main"},[n("el-card",[e._v("\n            更新时间:\n            "),n("span",{staticClass:"time",staticStyle:{float:"right"}},[e._v(e._s(e._f("timeFmt")(e.syncConfig.lastSuccTime)))])]),e._v(" "),e._l(e.groupByBranch,(function(t,r){return n("el-card",{key:r,staticClass:"box"},[n("div",{staticClass:"clearfix header",attrs:{slot:"header"},slot:"header"},[n("el-tag",{staticClass:"tag",attrs:{type:"info",size:"mini"}},[e._v(e._s(t.length))]),e._v("\n                "+e._s(r)+"\n                ")],1),e._v(" "),e._l(t,(function(t){return n("div",{key:t._id,staticClass:"body",on:{click:function(n){return e.openDrawer(t)}}},[n("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:e.tipText(t),placement:"top"}},[n("el-tag",{staticClass:"tag",attrs:{type:e.onlineMap(t),size:"mini"}},[e._v("\n                        "+e._s(t.region.camerasState.percent.online+"%")+"\n                    ")])],1),e._v(" "),n("span",{staticClass:"name",class:{offline:0===t.region.camerasState.percent.online}},[e._v("\n                    "+e._s(t.shortName)+"\n                ")]),e._v(" "),t.des?n("span",{staticClass:"des"},[n("el-tag",{staticClass:"branch",attrs:{type:"info",size:"mini"}},[e._v(e._s(t.des))])],1):e._e()],1)}))],2)}))],2),e._v(" "),e.open.drawer?[n("el-drawer",{staticClass:"drawer",attrs:{title:e.select.project.shortName,visible:e.open.drawer,direction:"rtl","destroy-on-close":!0,"before-close":e.closeDrawer,size:"80%"},on:{"update:visible":function(t){return e.$set(e.open,"drawer",t)}}},[n("ul",e._l(e.select.project.region.cameras,(function(t,r){return n("li",{key:t.cameraUuid,staticClass:"cameraItem",class:{offline:-1===t.check.delay},on:{click:function(t){return e.openCamera(r)}}},[n("span",{staticClass:"name"},[n("i",{staticClass:"el-icon-video-camera"}),e._v("\n                        "+e._s(r+1)+" "+e._s(t.cameraName)+"\n                    ")]),e._v(" "),n("span",{staticClass:"delay"},[e._v(e._s(e._f("delayFmt")(t.check.delay)))])])})),0),e._v(" "),e.open.camera?[n("VideoScroll",{attrs:{cameraList:e.select.project.region.cameras,project:e.select.project,index:e.select.indexCamera}}),e._v(" "),n("el-button",{staticClass:"close",attrs:{icon:"el-icon-close",circle:""},on:{click:function(t){e.open.camera=!1}}})]:e._e()],2)]:e._e()],2)},a=[],o=(n("8e6e"),n("ac6a"),n("456d"),n("ade3")),i=(n("a481"),n("2f62")),c=n("37b6"),s=n("2ef0"),l=n.n(s),u=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{ref:"swiper",staticClass:"swiper-container"},[n("div",{staticClass:"swiper-wrapper"},e._l(e.cameraList,(function(t,r){return n("div",{key:t._id,staticClass:"swiper-slide"},[n("Camera",{ref:"camera_"+r,refInFor:!0,staticClass:"camera",attrs:{index:r,camera:t,autoplay:!1,project:e.project,showFull:!1}})],1)})),0)])},d=[],p=(n("c5f6"),n("41d6")),f=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"boxWrap"},[n("div",{staticClass:"cBtns"}),e._v(" "),n("div",{staticClass:"box camera"},[n("div",{staticClass:"scale"},[n("div",{staticClass:"item"},[n("div",{directives:[{name:"show",rawName:"v-show",value:!e.autoplayControl,expression:"!autoplayControl"}],staticClass:"autoplay"},[n("el-button",{staticClass:"play",attrs:{icon:"el-icon-video-play",circle:""},on:{click:e.play}})],1),e._v(" "),n("Camera",{directives:[{name:"show",rawName:"v-show",value:e.autoplayControl,expression:"autoplayControl"}],ref:"camera",staticClass:"video",attrs:{camera:e.camera,project:e.project,autoplay:!1,controls:["toRefresh","toCheck"]}}),e._v(" "),n("div",{staticClass:"info"},[n("p",[e._v("\n                        "+e._s(e.index+1)+" "+e._s(e.project.shortName)+"-"+e._s(e.camera.cameraName)+"\n                        "+e._s(e._f("delayFmt")(e.camera.check.delay))+"\n                    ")])])],1)])])])},h=[],m=n("f3bd"),v={name:"",data:function(){return{manua:!1}},props:{index:{type:Number,required:!0},camera:{type:Object,required:!0},project:{type:Object,required:!0},autoplay:{type:Boolean,default:!0},full:{type:Boolean,default:!1}},computed:{autoplayControl:function(){return this.manua||this.autoplay}},methods:{play:function(){this.manua=!0,this.$refs.camera.init()},destroy:function(){this.$refs.camera.videoDestroy(),this.manua=!1}},components:{Camera:m["a"]}},y=v,g=(n("ddaf"),n("2877")),b=Object(g["a"])(y,f,h,!1,null,"04f5ed8f",null),w=b.exports,j={name:"",mounted:function(){var e=this;this.isPlay=new Array(this.cameraList.length),e.$nextTick((function(){e.swiper=new p["a"](e.$refs.swiper,{init:!1,direction:"vertical",initialSlide:e.index,on:{slideChangeTransitionEnd:function(){e.delayPlay()}}}),e.swiper.on("init",(function(){e.delayPlay()})),e.swiper.init()}))},data:function(){return{swiper:null,isPlay:[]}},props:{project:{type:Object,required:!0},index:{type:Number,default:0},cameraList:{type:Array,default:function(){return[]}}},components:{Camera:w},methods:{delayPlay:function(){var e=this;clearTimeout(this.timer),this.timer=setTimeout((function(){e.play()}),300)},play:function(){var e=this,t=this.swiper.activeIndex;this.isPlay[t]||(this.$refs["camera_".concat(t)][0].play(),this.isPlay[t]=!0),this.isPlay.forEach((function(n,r){var a=r>t+1||r<t-1;a&&(e.$refs["camera_".concat(r)][0].destroy(),delete e.isPlay[r])}))}},beforeDestroy:function(){this.swiper&&this.swiper.destroy()}},C=j,_=(n("d4e0"),Object(g["a"])(C,u,d,!1,null,"53691c81",null)),O=_.exports;function k(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function x(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?k(Object(n),!0).forEach((function(t){Object(o["a"])(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):k(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var R={name:"",mounted:function(){c["d"].isPhone||this.$router.replace({name:"video-preview"})},data:function(){return{open:{drawer:!1,camera:!1},select:{indexCamera:0,project:{}}}},computed:x(x({},Object(i["b"])(["projects"])),{},{filterByRegion:function(){return this.projects.filter((function(e){return e.regionUuid}))},groupByBranch:function(){return l.a.groupBy(this.filterByRegion,(function(e){return e.branch}))},syncConfig:function(){return this.$store.state.monitor.syncConfig}}),methods:{tipText:function(e){return"".concat(e.region.camerasState.count.online," / ").concat(e.region.camerasState.count.total)},onlineMap:function(e){return 100===e.region.camerasState.percent.online?"success":e.region.camerasState.percent.online<100&&e.region.camerasState.percent.online>0?"warning":0===e.region.camerasState.percent.online?"danger":""},openDrawer:function(e){this.select.project=e,this.open.drawer=!0},closeDrawer:function(){this.selectProject={},this.open.drawer=!1},openCamera:function(e){this.select.indexCamera=e,this.open.camera=!0}},components:{VideoScroll:O}},S=R,P=(n("c029"),Object(g["a"])(S,r,a,!1,null,"1d2a51c3",null));t["default"]=P.exports},"9ad3":function(e,t,n){"use strict";n("e19b")},bd96:function(e,t,n){},c029:function(e,t,n){"use strict";n("e815")},d4e0:function(e,t,n){"use strict";n("dede")},ddaf:function(e,t,n){"use strict";n("bd96")},dede:function(e,t,n){},e19b:function(e,t,n){},e815:function(e,t,n){},f3bd:function(e,t,n){"use strict";var r=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{ref:"video",staticClass:"video"})},a=[],o=(n("6762"),n("2fdb"),n("96cf"),n("1da1")),i=n("c0f46"),c=(n("8e6e"),n("ac6a"),n("456d"),n("ade3")),s=(n("a481"),n("37b6")),l=n("7cf8");function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){Object(c["a"])(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var p="/img/hls/loading.gif";function f(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};console.log("camera",t);var a=t.cameraUuid,o=t.cameraName,i=t.check,c=void 0===i?{}:i,u=c.lastOnlineChannel,f=void 0===u?1:u,h=n.shortName,m=s["c"].replace("{cdn}",a.substring(0,5)).replace("{cameraUuid}",a).replace("{channel}",f),v=Object.assign({container:e,video:{url:m,pic:p},volume:0,live:!0,autoplay:!0,mutex:!1,pluginOptions:{hls:{manifestLoadingTimeOut:6e4,manifestLoadingMaxRetry:3,fragLoadingTimeOut:2e3,fragLoadingMaxRetry:5,fragLoadingRetryDelay:10}},controls:{volume:!1,play:!1,live:!1}},r),y=new DPlayer(v);return y._isDestroy=!1,y.on("error",(function(e){console.log("dplayer err",e)})),y.on("canplay",(function(){console.log("canplay",123),t.check.delay>0||Object(l["c"])(a).then((function(e){t.check=d({},e.result.check)})).catch((function(e){console.log("err",e)})).finally((function(){}))})),y.on("play",(function(){console.log("play",123)})),y.on("waiting",(function(){console.log("waiting",123)})),y.on("destroy",(function(){y._isDestroy=!0})),y.plugins.hls&&y.plugins.hls.on(Hls.Events.ERROR,(function(e,t){if(console.log(e,t.fatal,t.type,h,o,a,t),!y._isDestroy&&t.fatal)switch(t.type){case Hls.ErrorTypes.MEDIA_ERROR:y.plugins.hls.recoverMediaError();break;case Hls.ErrorTypes.NETWORK_ERROR:y.plugins.hls.startLoad();break;default:console.log("hls default error",t.type);break}})),console.log("dp",y,y.type,y.plugins),y}var h=f,m='<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 32 32">\n    <path d="M16 23c-3.309 0-6-2.691-6-6s2.691-6 6-6 6 2.691 6 6-2.691 6-6 6zM16 13c-2.206 0-4 1.794-4 4s1.794 4 4 4c2.206 0 4-1.794 4-4s-1.794-4-4-4zM27 28h-22c-1.654 0-3-1.346-3-3v-16c0-1.654 1.346-3 3-3h3c0.552 0 1 0.448 1 1s-0.448 1-1 1h-3c-0.551 0-1 0.449-1 1v16c0 0.552 0.449 1 1 1h22c0.552 0 1-0.448 1-1v-16c0-0.551-0.448-1-1-1h-11c-0.552 0-1-0.448-1-1s0.448-1 1-1h11c1.654 0 3 1.346 3 3v16c0 1.654-1.346 3-3 3zM24 10.5c0 0.828 0.672 1.5 1.5 1.5s1.5-0.672 1.5-1.5c0-0.828-0.672-1.5-1.5-1.5s-1.5 0.672-1.5 1.5zM15 4c0 0.552-0.448 1-1 1h-4c-0.552 0-1-0.448-1-1v0c0-0.552 0.448-1 1-1h4c0.552 0 1 0.448 1 1v0z"></path>\n</svg>',v={name:"",mounted:function(){this.camera&&this.camera._id&&this.autoplay&&this.init()},data:function(){return{isInit:!1,loading:{toCheck:!1},dp:null,msg:null}},props:{camera:{type:Object,required:!0},project:{type:Object,required:!0},autoplay:{type:Boolean,default:!0},controls:{type:Array,default:function(){return["toRefresh","toTv","toCheck"]}}},watch:{"loading.toCheck":function(){var e=this.dp.container.querySelector(".dplayer-icons-right"),t=e.querySelector(".toCheck");t&&(this.loading.toCheck?t.classList.add("loading"):t.classList.remove("loading"))}},methods:{init:function(){var e=this;console.log("init"),this.isInit||(this.isInit=!0,this.dp=h(this.$refs.video,this.camera,this.project,{initFinish:this.addBtn,contextmenu:[{text:"重新载入",click:function(){var t=Object(o["a"])(regeneratorRuntime.mark((function t(n){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.videoRefresh();case 2:case"end":return t.stop()}}),t)})));function n(e){return t.apply(this,arguments)}return n}()}]}),this.dp.on("destroy",(function(){var t=e.dp.container.querySelector(".dplayer-icons-right");t&&(t.querySelector(".toRefresh")&&t.querySelector(".toRefresh").removeEventListener("click",e.videoRefresh),t.querySelector(".toTv")&&t.querySelector(".toTv").removeEventListener("click",e.toTv),t.querySelector(".toCheck")&&t.querySelector(".toCheck").removeEventListener("click",e.toCheck))})))},addBtn:function(){var e=this.$refs.video.querySelector(".dplayer-icons-left");this.controls.includes("toRefresh")&&(e.insertAdjacentHTML("afterbegin",'<div class="diy toRefresh" data-balloon="刷新" data-balloon-pos="up">\n                    <i class="icon el-icon-refresh-right"></i>\n                </div>'),e.querySelector(".toRefresh").addEventListener("click",this.videoRefresh));var t=this.$refs.video.querySelector(".dplayer-icons-right");this.controls.includes("toTv")&&(t.insertAdjacentHTML("afterbegin",'<div class="diy toTv" data-balloon="上墙" data-balloon-pos="up">\n                    <button class="dplayer-icon">上墙</button></div>\n                </div>'),t.querySelector(".toTv").addEventListener("click",this.toTv)),this.controls.includes("toCheck")&&(t.insertAdjacentHTML("afterbegin",'<div class="dplayer-icon toCheck" data-balloon="整改通知单" data-balloon-pos="up">\n                    <span class="dplayer-icon-content">'.concat(m,"</span>\n                </div>")),t.querySelector(".toCheck").addEventListener("click",this.toCheck))},toTv:function(){var e=this;Object(l["a"])({wId:1,camera:Object(i["ajaxCameraHandle"])(this.camera)}).then((function(t){e.$message.success("上墙成功")})).catch((function(e){console.log("err",e)}))},toCheck:function(){var e=Object(o["a"])(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(e.prev=0,!this.loading.toCheck){e.next=3;break}return e.abrupt("return");case 3:return this.loading.toCheck=!0,e.next=6,Object(i["videoToImgs"])(this.dp.video);case 6:return t=e.sent,e.next=9,this.ajaxUploadImg(t);case 9:e.next=15;break;case 11:e.prev=11,e.t0=e["catch"](0),console.log("error",e.t0),this.$message.error("获取图片错误 ".concat(e.t0.message));case 15:return e.prev=15,this.loading.toCheck=!1,e.finish(15);case 18:case"end":return e.stop()}}),e,this,[[0,11,15,18]])})));function t(){return e.apply(this,arguments)}return t}(),ajaxUploadImg:function(e){var t=this;return new Promise((function(n,r){var a=e.blob;if(!a)return t.$message.error("获取图片失败"),void n();var o=t.camera,c=o.cameraUuid,s=o.cameraName,u=t.project,d=u._id,p=u.shortName,f="".concat(p,"_").concat(s,"_").concat(Date.now()),h=new window.FormData;h.append("file",a,"".concat(f,".png")),t.msg=t.$message({showClose:!0,message:"图片上传中 ".concat(f),duration:0}),Object(l["z"])(d,h).then((function(e){t.$message({type:"success",message:"图片上传成功 ".concat(f)}),t.$store.state.monitor.checkForm.openForm({pId:d,cId:c,imgs:[e.result]})})).catch((function(e){t.$message({type:"error",message:"图片上传失败 已下载到本地 ".concat(e.message," ").concat(f)}),Object(i["blobToDownload"])(a,f)})).finally((function(){t.msg&&t.msg.close(),n()}))}))},videoRefresh:function(){var e=Object(o["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this.videoDestroy(),e.next=3,Object(i["sleep"])(100);case 3:this.init();case 4:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}(),videoDestroy:function(){this.dp&&this.dp.destroy()}},beforeDestroy:function(){this.videoDestroy()}},y=v,g=(n("9ad3"),n("2877")),b=Object(g["a"])(y,r,a,!1,null,"55bf0b8c",null);t["a"]=b.exports}}]);